<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Station - SeQueueR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-2xl w-full bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-blue-900 mb-2 flex items-center gap-3">
            <i class="fas fa-desktop"></i>
            Quick Station Registration
        </h1>
        <p class="text-gray-600 mb-6">Register this PC's MAC address to automatically assign it to a counter</p>
        
        <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <span id="successText"></span>
        </div>
        
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="errorText"></span>
        </div>
        
        <form id="registrationForm" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-tag mr-2"></i>
                    Station Name
                </label>
                <input 
                    type="text" 
                    id="stationName" 
                    name="station_name"
                    placeholder="e.g., Counter 1 PC, Guidance Office PC"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    required
                />
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-network-wired mr-2"></i>
                    MAC Address
                </label>
                <input 
                    type="text" 
                    id="macAddress" 
                    name="mac_address"
                    placeholder="BC-03-58-57-26-1E"
                    pattern="^([0-9A-Fa-f]{2}[-:]){5}[0-9A-Fa-f]{2}$"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono"
                    required
                />
                <p class="text-xs text-gray-500 mt-1">Format: XX-XX-XX-XX-XX-XX or XX:XX:XX:XX:XX:XX</p>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-hashtag mr-2"></i>
                    Counter Number
                </label>
                <select 
                    id="counterNumber" 
                    name="counter_number"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    required
                >
                    <option value="">Select Counter</option>
                    <option value="1">Counter 1 (Regular)</option>
                    <option value="2">Counter 2 (Regular)</option>
                    <option value="3">Counter 3 (Regular)</option>
                    <option value="4">Counter 4 (Priority)</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-globe mr-2"></i>
                    IP Address (Optional)
                </label>
                <input 
                    type="text" 
                    id="ipAddress" 
                    name="ip_address"
                    placeholder="192.168.1.100 (optional)"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono"
                />
            </div>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-semibold text-blue-900 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>
                    How to find your MAC Address:
                </h3>
                <div class="text-sm text-blue-800 space-y-2">
                    <p><strong>Windows:</strong></p>
                    <ol class="list-decimal ml-5 space-y-1">
                        <li>Open Command Prompt</li>
                        <li>Type: <code class="bg-white px-2 py-1 rounded">ipconfig /all</code></li>
                        <li>Look for "Physical Address" under your active network adapter</li>
                    </ol>
                    <p class="mt-3"><strong>Example:</strong> Physical Address: BC-03-58-57-26-1E</p>
                </div>
            </div>
            
            <button 
                type="submit"
                class="w-full bg-blue-900 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-800 transition flex items-center justify-center gap-2"
            >
                <i class="fas fa-save"></i>
                Register Station
            </button>
        </form>
        
        <div class="mt-6 text-center">
            <a href="Frontend/Personnel/Admin/Settings.php" class="text-blue-600 hover:underline text-sm">
                <i class="fas fa-arrow-left mr-1"></i>
                Back to Settings
            </a>
            <span class="mx-2 text-gray-400">|</span>
            <a href="Frontend/Personnel/Signin.php" class="text-blue-600 hover:underline text-sm">
                <i class="fas fa-sign-in-alt mr-1"></i>
                Go to Login
            </a>
        </div>
    </div>
    
    <script>
        // Auto-detect IP address
        fetch('https://api.ipify.org?format=json')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ipAddress').value = data.ip;
            })
            .catch(() => {
                // Ignore error, IP is optional
            });
        
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('action', 'register_station');
            formData.append('station_name', document.getElementById('stationName').value);
            formData.append('mac_address', document.getElementById('macAddress').value.toUpperCase());
            formData.append('counter_number', document.getElementById('counterNumber').value);
            formData.append('ip_address', document.getElementById('ipAddress').value);
            
            // Disable submit button
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Registering...';
            
            try {
                // Send to database via PHP API
                const response = await fetch('register_station_api_v2.php', {
                    method: 'POST',
                    body: formData
                });
                
                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                
                // Get response text first to debug
                const responseText = await response.text();
                console.log('Server response:', responseText);
                
                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (jsonError) {
                    throw new Error(`Invalid server response. Please check if the database table exists. Response: ${responseText.substring(0, 200)}`);
                }
                
                if (data.success) {
                    // Also store in localStorage for quick client-side access
                    const station = {
                        name: document.getElementById('stationName').value,
                        mac: document.getElementById('macAddress').value.toUpperCase(),
                        counter: document.getElementById('counterNumber').value,
                        ip: document.getElementById('ipAddress').value,
                        registered: new Date().toISOString()
                    };
                    localStorage.setItem('station_config', JSON.stringify(station));
                    
                    // Show success
                    document.getElementById('successText').textContent = 
                        `Station registered successfully! This PC will auto-assign to Counter ${station.counter} on login.`;
                    document.getElementById('successMessage').classList.remove('hidden');
                    document.getElementById('errorMessage').classList.add('hidden');
                    
                    // Reset form
                    e.target.reset();
                    
                    // Redirect after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'Frontend/Personnel/Signin.php';
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Registration failed');
                }
                
            } catch (error) {
                document.getElementById('errorText').textContent = 'Registration failed: ' + error.message;
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('successMessage').classList.add('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Register Station';
            }
        });
        
        // Format MAC address as user types
        document.getElementById('macAddress').addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase().replace(/[^0-9A-F]/g, '');
            if (value.length > 12) value = value.substr(0, 12);
            
            // Add dashes every 2 characters
            let formatted = '';
            for (let i = 0; i < value.length; i += 2) {
                if (i > 0) formatted += '-';
                formatted += value.substr(i, 2);
            }
            
            e.target.value = formatted;
        });
    </script>
</body>
</html>
